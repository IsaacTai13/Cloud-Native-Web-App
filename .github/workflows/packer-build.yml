name: Packer Build (on merge)

on:
  push:
    branches: [ main ] # treat "PR merged" as push to main

permissions:
  contents: read

concurrency:
  group: packer-build-main
  cancel-in-progress: false

jobs:
  # --- Job 1: Integration tests + build artifact on runner ---
  build-artifact:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        ports:
          - "5432:5432"
        env:
          POSTGRES_USER: ${{ vars.DB_USERNAME }}
          POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
          POSTGRES_DB: ${{ vars.DB_NAME }}
        options: >-
          --health-cmd="pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=12

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Install Postgres client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for Postgres to be ready
        run: |
          for i in {1..30}; do
            pg_isready -h ${{ vars.DB_HOST }} -p ${{ vars.DB_PORT }} -U ${{ vars.DB_USERNAME }} && break
            sleep 2
          done

      - name: Run tests (use ci profile)
        env:
          DB_HOST: ${{ vars.DB_HOST }}
          DB_PORT: ${{ vars.DB_PORT }}
          DB_NAME: ${{ vars.DB_NAME }}
          DB_USERNAME: ${{ vars.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_CONN_TIMEOUT_MS: ${{ vars.DB_CONN_TIMEOUT_MS }}
          SPRING_PROFILES_ACTIVE: ci
        run: mvn -B test

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ github.run_id }}
          path: |
            **/target/surefire-reports/**
            **/target/failsafe-reports/**

      # Build the application artifact on the runner (not inside Packer image)
      - name: Build application
        run: mvn -B -DskipTests package

      # Zip the build output so Packer can upload it to EC2
      - name: Package artifact
        run: |
          mkdir -p packer/scripts
          zip -r packer/scripts/webapp.zip target/

      # Make the zip available to the next job
      - name: Upload artifact for Packer
        uses: actions/upload-artifact@v4
        with:
          name: webapp
          path: packer/scripts/webapp.zip
          if-no-files-found: error

  # --- Job 2: Build AMI with Packer (depends on Job 1 success) ---
  packer-build:
    runs-on: ubuntu-latest
    needs: build-artifact
    
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}

      # --- AWS / Infra ---
      PKR_VAR_region: ${{ vars.AWS_REGION }}
      PKR_VAR_instance_type: ${{ vars.INSTANCE_TYPE }}
      PKR_VAR_ssh_username: ${{ vars.SSH_USERNAME }}
      PKR_VAR_vpc_id: ${{ vars.VPC_ID }}
      PKR_VAR_subnet_id: ${{ vars.SUBNET_ID }}
      PKR_VAR_security_group_id: ${{ vars.SECURITY_GROUP_ID }}
      PKR_VAR_demo_account_id: ${{ vars.DEMO_ACCOUNT_ID }}

      # --- App / DB config ---
      PKR_VAR_shell_env__db_type: ${{ vars.DB_TYPE }}
      PKR_VAR_shell_env__db_name: ${{ vars.DB_NAME }}
      PKR_VAR_shell_env__db_user: ${{ vars.DB_USERNAME }}
      PKR_VAR_shell_env__db_pass: ${{ secrets.DB_PASSWORD }}
      PKR_VAR_shell_env__app_group: ${{ vars.APP_GROUP }}
      PKR_VAR_shell_env__app_user: ${{ vars.APP_USER }}
      PKR_VAR_shell_env__app_dir: ${{ vars.APP_DIR }}
      PKR_VAR_shell_env__app_env_file: ${{ vars.APP_ENV_FILE }}

      PKR_VAR_web_env__db_host: ${{ vars.DB_HOST }}
      PKR_VAR_web_env__db_port: ${{ vars.DB_PORT }}
      PKR_VAR_web_env__db_password: ${{ secrets.DB_PASSWORD }}
      PKR_VAR_web_env__db_conn_timeout_ms: ${{ vars.DB_CONN_TIMEOUT_MS }}
      PKR_VAR_web_env__server_port: ${{ vars.SERVER_PORT }}
      PKR_VAR_web_env__api_base: ${{ vars.API_BASE }}
      PKR_VAR_shell_env__app_archive_path: /tmp

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: webapp
          path: packer/scripts/

      - name: Setup Packer
        uses: hashicorp/setup-packer@v2
        with:
          packer_version: 1.11.0

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: Versions
        run: |
          packer -v
          aws --version

      - name: Packer fmt/validate
        working-directory: packer
        run: |
          packer fmt -check -recursive .
          packer init .
          packer validate .

      - name: Packer build
        working-directory: packer
        run: packer build .
